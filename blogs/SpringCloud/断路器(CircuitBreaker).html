<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>断路器 | Junlogz-Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/images/favicon.png">
    <meta name="description" content="Junlogz-Blog notes">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/assets/css/0.styles.e853742c.css" as="style"><link rel="preload" href="/assets/js/app.00ab6ad1.js" as="script"><link rel="preload" href="/assets/js/3.063946e3.js" as="script"><link rel="preload" href="/assets/js/1.f0dee50d.js" as="script"><link rel="preload" href="/assets/js/19.41d9e123.js" as="script"><link rel="prefetch" href="/assets/js/10.27468c1b.js"><link rel="prefetch" href="/assets/js/11.6f8e22bc.js"><link rel="prefetch" href="/assets/js/12.20ec64b2.js"><link rel="prefetch" href="/assets/js/13.b27443aa.js"><link rel="prefetch" href="/assets/js/14.16b26e4d.js"><link rel="prefetch" href="/assets/js/15.67aa604b.js"><link rel="prefetch" href="/assets/js/16.43ae5be8.js"><link rel="prefetch" href="/assets/js/17.68cfdfe7.js"><link rel="prefetch" href="/assets/js/18.63ee2625.js"><link rel="prefetch" href="/assets/js/20.28721e78.js"><link rel="prefetch" href="/assets/js/21.8a39e932.js"><link rel="prefetch" href="/assets/js/22.ea7ba8e0.js"><link rel="prefetch" href="/assets/js/23.5fd224e6.js"><link rel="prefetch" href="/assets/js/4.b49c536d.js"><link rel="prefetch" href="/assets/js/5.aa6c9511.js"><link rel="prefetch" href="/assets/js/6.098780c7.js"><link rel="prefetch" href="/assets/js/7.4c822714.js"><link rel="prefetch" href="/assets/js/8.69f56ef7.js"><link rel="prefetch" href="/assets/js/9.85f8c3a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e853742c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Junlogz-Blog</h3> <p class="description" data-v-59e6cb88>Junlogz-Blog notes</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Junlogz</span>
          
        <span data-v-59e6cb88>2022 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="Junlogz-Blog" class="logo"> <span class="site-name">Junlogz-Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      中间件框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/redis/" class="nav-link"><i class="undefined"></i>
  Redis缓存
</a></li><li class="dropdown-item"><!----> <a href="/docs/mq/" class="nav-link"><i class="undefined"></i>
  MQ消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      其他技术栈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/SpringCloud/" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Junlogz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/images/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Junlogz
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>13</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>3</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      中间件框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/redis/" class="nav-link"><i class="undefined"></i>
  Redis缓存
</a></li><li class="dropdown-item"><!----> <a href="/docs/mq/" class="nav-link"><i class="undefined"></i>
  MQ消息队列
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      其他技术栈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/Nginx/" class="nav-link"><i class="undefined"></i>
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/categories/SpringCloud/" class="nav-link"><i class="undefined"></i>
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Junlogz" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>断路器</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Junlogz</span>
          
        <span data-v-59e6cb88>2022 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">断路器</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Junlogz</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>SpringCloud</span></i></div></div> <div class="content__default"><h1 id="_1-微服务容错"><a href="#_1-微服务容错" class="header-anchor">#</a> 1. 微服务容错</h1> <h2 id="_1-1-微服务容错简介"><a href="#_1-1-微服务容错简介" class="header-anchor">#</a> 1.1 微服务容错简介</h2> <p>在高并发访问下，比如天猫双11，流量持续不断的涌入，服务之间的相互调用频率突然增加，引发系统负载过高，这时系统所依赖的服务的稳定性对系统的影响非常大，而且还有很多不确定因素引起雪崩，如网络连接中断，服务宕机等。一般微服务容错组件提供了限流、隔离、降级、熔断等手段，可以有效保护我们的微服务系统。</p> <h3 id="_1-1-1-隔离"><a href="#_1-1-1-隔离" class="header-anchor">#</a> 1.1.1 隔离</h3> <p>微服务系统A调用B，而B调用C，这时如果C出现故障，则此时调用B的大量线程资源阻塞，慢慢的B的线程数量持续增加直到CPU耗尽到100%，整体微服务不可用，这时就需要对不可用的服务进行隔离。服务调用关系如图4-1所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416191421.png" style="zoom:67%;"> <ol><li>线程池隔离</li></ol> <p>线程池隔离就是通过Java的线程池进行隔离，B服务调用C服务给予固定的线程数量比如12个线程，如果此时C服务宕机了就算大量的请求过来，调用C服务的接口只会占用12个线程不会占用其他工作线程资源，因此B服务就不会出现级联故障。线程池隔离原理，如图所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416191530.png" style="zoom:67%;"> <ol start="2"><li>信号量隔离</li></ol> <p>隔离信号量隔离是使用Semaphore来实现的，当拿不到信号量的时候直接拒接因此不会出现超时占用其他工作线程的情况。代码如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Semaphore semaphore = new Semaphore(10,true);  
//获取信号量  
semaphore.acquire();  
//do something here  
//释放信号量  
semaphore.release();  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="3"><li>线程池隔离和信号量隔离的区别</li></ol> <p>线程池隔离针对不同的资源分别创建不同的线程池，不同服务调用都发生在不同的线程池中，在线程池排队、超时等阻塞情况时可以快速失败。线程池隔离的好处是隔离度比较高，可以针对某个资源的线程池去进行处理而不影响其它资源，但是代价就是线程上下文切换的 overhead 比较大，特别是对低延时的调用有比较大的影响。而信号量隔离非常轻量级，仅限制对某个资源调用的并发数，而不是显式地去创建线程池，所以 overhead 比较小，但是效果不错，也支持超时失败。二者区别如表所示。</p> <table><thead><tr><th>类别</th> <th>线程池隔离</th> <th>信号量隔离</th></tr></thead> <tbody><tr><td>线程</td> <td>与调用线程不同，使用的是线程池创建的线程</td> <td>与调用线程相同</td></tr> <tr><td>开销</td> <td>排队，切换，调度等开销</td> <td>无线程切换性能更高</td></tr> <tr><td>是否支持异步</td> <td>支持</td> <td>不支持</td></tr> <tr><td>是否支持超时</td> <td>支持超时</td> <td>支持超时</td></tr> <tr><td>并发支持</td> <td>支持通过线程池大小控制</td> <td>支持通过最大信号量控制</td></tr></tbody></table> <h3 id="_1-1-2-熔断"><a href="#_1-1-2-熔断" class="header-anchor">#</a> 1.1.2 熔断</h3> <p>当下游的服务因为某种原因突然变得不可用或响应过慢，上游服务为了保证自己整体服务的可用性，不再继续调用目标服务，直接返回，快速释放资源。如果目标服务情况好转则恢复调用。熔断器模型，如图所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416191952.png" style="zoom:67%;"> <p>熔断器模型的状态机有3个状态。</p> <ul><li>Closed：关闭状态（断路器关闭），所有请求都正常访问。</li> <li>Open：打开状态（断路器打开），所有请求都会被降级。熔断器会对请求情况计数，当一定时间内失败请求百分比达到阈值，则触发熔断，断路器会完全打开。</li> <li>Half Open：半开状态，不是永久的，断路器打开后会进入休眠时间。随后断路器会自动进入半开状态。此时会释放部分请求通过，若这些请求都是健康的，则会关闭断路器，否则继续保持打开，再次进行休眠计时。</li></ul> <h3 id="_1-1-3-降级"><a href="#_1-1-3-降级" class="header-anchor">#</a> 1.1.3 降级</h3> <p>降级是指当自身服务压力增大时，系统将某些不重要的业务或接口的功能降低，可以只提供部分功能，也可以完全停止所有不重要的功能。比如，下线非核心服务以保证核心服务的稳定、降低实时性、降低数据一致性，降级的思想是丢车保帅。</p> <p>举个例子，比如，目前很多人想要下订单，但是我的服务器除了处理下订单业务之外，还有一些其他的服务在运行，比如，搜索、定时任务、支付、商品详情、日志等等服务。然而这些不重要的服务占用了JVM的不少内存和CPU资源，为了应对很多人要下订单的需求，设计了一个动态开关，把这些不重要的服务直接在最外层拒绝掉。这样就有跟多的资源来处理下订单服务（下订单速度更快了）</p> <h3 id="_1-1-4-限流"><a href="#_1-1-4-限流" class="header-anchor">#</a> 1.1.4 限流</h3> <p>限流，就是限制最大流量。系统能提供的最大并发有限，同时来的请求又太多，就需要限流，比如商城秒杀业务，瞬时大量请求涌入，服务器服务不过来，就只好排队限流了，就跟去景点排队买票和去银行办理业务排队等号道理相同。下面介绍下四种常见的限流算法。</p> <ol><li>漏桶算法</li></ol> <p>漏桶算法的思路，一个固定容量的漏桶，按照常量固定速率流出水滴。如果桶是空的，则不需流出水滴。可以以任意速率流入水滴到漏桶。如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。漏桶限流原理，如图所示。</p> <p><img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416193030.png" alt=""></p> <ol start="2"><li>令牌桶算法</li></ol> <p>令牌桶算法：假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌。桶中最多存放b个令牌，当桶满时，新添加的令牌被丢弃或拒绝。当一个n个字节大小的数据包到达，将从桶中删除n个令牌，接着数据包被发送到网络上。如果桶中的令牌不足n个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。令牌桶限流原理，如图所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416193133.png" style="zoom:67%;"> <p>令牌桶限流服务器端可以根据实际服务性能和时间段改变生成令牌的速度和水桶的容量。 一旦需要提高速率,则按需提高放入桶中的令牌的速率。</p> <p>生成令牌的速度是恒定的，而请求去拿令牌是没有速度限制的。这意味着当面对瞬时大流量，该算法可以在短时间内请求拿到大量令牌，而且拿令牌的过程并不是消耗很大。</p> <ol start="3"><li>固定时间窗口算法</li></ol> <p>固定的时间窗口内，可以允许固定数量的请求进入。超过数量就拒绝或者排队，等下一个时间段进入。这种实现计数器限流方式由于是在一个时间间隔内进行限制，如果用户在上个时间间隔结束前请求（但没有超过限制），同时在当前时间间隔刚开始请求（同样没超过限制），在各自的时间间隔内，这些请求都是正常的，但是将间隔临界的一段时间内的请求就会超过系统限制，可能导致系统被压垮。固定时间窗口算法原理，如图所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416193221.png" style="zoom:67%;"> <p>由于计数器算法存在时间临界点缺陷，因此在时间临界点左右的极短时间段内容易遭到攻击。比如设定每分钟最多可以请求100次某个接口，如12:00:00-12:00:59时间段内没有数据请求，而12:00:59-12:01:00时间段内突然并发100次请求，而紧接着跨入下一个计数周期，计数器清零，在12:01:00-12:01:01内又有100次请求。那么也就是说在时间临界点左右可能同时有2倍的阀值进行请求，从而造成后台处理请求过载的情况，导致系统运营能力不足，甚至导致系统崩溃。</p> <ol start="4"><li>滑动时间窗口算法</li></ol> <p>滑动窗口算法是把固定时间片进行划分，并且随着时间移动，移动方式为开始时间点变为时间列表中的第二时间点，结束时间点增加一个时间点，不断重复，通过这种方式可以巧妙的避开计数器的临界点的问题。</p> <p>滑动窗口算法可以有效的规避计数器算法中时间临界点的问题，但是仍然存在时间片段的概念。同时滑动窗口算法计数运算也相对固定时间窗口算法比较耗时。滑动时间窗口算法，如图所示。</p> <img src="https://junlog-1309703877.cos.ap-nanjing.myqcloud.com/img/20220416193238.png" style="zoom:67%;"> <h2 id="_1-2-resilience4j简介"><a href="#_1-2-resilience4j简介" class="header-anchor">#</a> 1.2 Resilience4j简介</h2> <h3 id="_1-2-1-resilience4j简介"><a href="#_1-2-1-resilience4j简介" class="header-anchor">#</a> 1.2.1 Resilience4j简介</h3> <p>Netflix的Hystrix微服务容错库已经停止更新，官方推荐使用Resilience4j代替Hystrix，或者使用Spring Cloud Alibaba的Sentinel组件。</p> <p>Resilience4j是受到Netflix Hystrix的启发，为Java8和函数式编程所设计的轻量级容错框架。整个框架只是使用了Varr的库，不需要引入其他的外部依赖。与此相比，Netflix Hystrix对Archaius具有编译依赖，而Archaius需要更多的外部依赖，例如Guava和Apache Commons Configuration。</p> <p>Resilience4j提供了提供了一组高阶函数（装饰器），包括断路器，限流器，重试机制，隔离机制。你可以使用其中的一个或多个装饰器对函数式接口，lambda表达式或方法引用进行装饰。这么做的优点是你可以选择所需要的装饰器进行装饰。</p> <p>在使用Resilience4j的过程中，不需要引入所有的依赖，只引入需要的依赖即可。</p> <p>核心模块</p> <ul><li>resilience4j-circuitbreaker: 熔断</li> <li>resilience4j-ratelimiter: 限流</li> <li>resilience4j-bulkhead: 隔离</li> <li>resilience4j-retry: 自动重试</li> <li>resilience4j-cache: 结果缓存</li> <li>resilience4j-timelimiter: 超时处理</li></ul> <h3 id="_1-2-2-resilience4j和hystrix的异同"><a href="#_1-2-2-resilience4j和hystrix的异同" class="header-anchor">#</a> 1.2.2 Resilience4j和Hystrix的异同</h3> <ul><li>Hystrix使用HystrixCommand来调用外部的系统，而R4j提供了一些高阶函数，例如断路器、限流器、隔离机制等，这些函数作为装饰器对函数式接口、lambda表达式、函数引用进行装饰。此外，R4j库还提供了失败重试和缓存调用结果的装饰器。你可以在函数式接口、lambda表达式、函数引用上叠加地使用一个或多个装饰器，这意味着隔离机制、限流器、重试机制等能够进行组合使用。这么做的优点在于，你可以根据需要选择特定的装饰器。任何被装饰的方法都可以同步或异步执行，异步执行可以采用 CompletableFuture 或RxJava。</li> <li>当有很多超过规定响应时间的请求时，在远程系统没有响应和引发异常之前，断路器将会开启。</li> <li>当Hystrix处于半开状态时，Hystrix根据只执行一次请求的结果来决定是否关闭断路器。而R4j允许执行可配置次数的请求，将请求的结果和配置的阈值进行比较来决定是否关闭断路器。</li> <li>R4j提供了自定义的Reactor和Rx Java操作符对断路器、隔离机制、限流器中任何的反应式类型进行装饰。</li> <li>Hystrix和R4j都发出一个事件流，系统可以对发出的事件进行监听，得到相关的执行结果和延迟的时间统计数据都是十分有用的。</li></ul> <h1 id="_2-断路器-circuitbreaker"><a href="#_2-断路器-circuitbreaker" class="header-anchor">#</a> 2. 断路器(CircuitBreaker)</h1> <h2 id="_2-1-circuitbreaker简介"><a href="#_2-1-circuitbreaker简介" class="header-anchor">#</a> 2.1 CircuitBreaker简介</h2> <p>  断路器通过有限状态机实现，有三个普通状态：关闭（<strong>CLOSED</strong>）、开启（<strong>OPEN</strong>）、半开(<strong>HALF_OPEN</strong>)，还有两个特殊状态：禁用(<strong>DISABLED</strong>)、强制开启(<strong>FORCED_OPEN</strong>)。如下图所示。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/875a486610ae40baa5f06353c1256500~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>  当熔断器关闭时，所有的请求都会通过熔断器。如果失败率超过设定的阈值，熔断器就会从关闭状态转换到打开状态，这时所有的请求都会被拒绝。当经过一段时间后，熔断器会从打开状态转换到半开状态，这时仅有一定数量的请求会被放入，并重新计算失败率，如果失败率超过阈值，则变为打开状态，如果失败率低于阈值，则变为关闭状态。</p> <p>  断路器使用滑动窗口来存储和统计调用的结果。你可以选择基于调用数量的滑动窗口或者基于时间的滑动窗口。基于访问数量的滑动窗口统计了最近N次调用的返回结果。居于时间的滑动窗口统计了最近N秒的调用返回结果。</p> <p>  除此以外，熔断器还会有两种特殊状态：<em><strong>DISABLED</strong></em>（始终允许访问）和***FORCED_OPEN***（始终拒绝访问）。这两个状态不会生成熔断器事件（除状态装换外），并且不会记录事件的成功或者失败。退出这两个状态的唯一方法是触发状态转换或者重置熔断器。</p> <h2 id="_2-2-添加依赖"><a href="#_2-2-添加依赖" class="header-anchor">#</a> 2.2 添加依赖</h2> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>        &lt;dependency<span class="token punctuation">&gt;</span>
            &lt;groupId<span class="token punctuation">&gt;</span>org.springframework.cloud&lt;/groupId<span class="token punctuation">&gt;</span>
            &lt;artifactId<span class="token punctuation">&gt;</span>spring<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>starter<span class="token punctuation">-</span>circuitbreaker<span class="token punctuation">-</span>resilience4j&lt;/artifactId<span class="token punctuation">&gt;</span>
        &lt;/dependency<span class="token punctuation">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_2-3-circuitbreaker配置"><a href="#_2-3-circuitbreaker配置" class="header-anchor">#</a> 2.3 CircuitBreaker配置</h2> <p>  断路器配置属性，如下表所示</p> <table><thead><tr><th><strong>配置属性</strong></th> <th><strong>默认值</strong></th> <th><strong>描述</strong></th></tr></thead> <tbody><tr><td>failureRateThreshold</td> <td>50</td> <td>以百分比配置失败率阈值。当失败率等于或大于阈值时，断路器状态并关闭变为开启，并进行服务降级。</td></tr> <tr><td>slowCallRateThreshold</td> <td>100</td> <td>以百分比的方式配置，断路器把调用时间大于slowCallDurationThreshold的调用视为慢调用，当慢调用比例大于等于阈值时，断路器开启，并进行服务降级。</td></tr> <tr><td>slowCallDurationThreshold</td> <td>60000 [ms]</td> <td>配置调用时间的阈值，高于该阈值的呼叫视为慢调用，并增加慢调用比例。</td></tr> <tr><td>permittedNumberOfCallsInHalfOpenState</td> <td>10</td> <td>断路器在半开状态下允许通过的调用次数。</td></tr> <tr><td>maxWaitDurationInHalfOpenState</td> <td>0</td> <td>断路器在半开状态下的最长等待时间，超过该配置值的话，断路器会从半开状态恢复为开启状态。配置是0时表示断路器会一直处于半开状态，直到所有允许通过的访问结束。</td></tr> <tr><td>slidingWindowType</td> <td>COUNT_BASED</td> <td>配置滑动窗口的类型，当断路器关闭时，将调用的结果记录在滑动窗口中。滑动窗口的类型可以是count-based或time-based。如果滑动窗口类型是COUNT_BASED，将会统计记录最近slidingWindowSize次调用的结果。如果是TIME_BASED，将会统计记录最近slidingWindowSize秒的调用结果。</td></tr> <tr><td>slidingWindowSize</td> <td>100</td> <td>配置滑动窗口的大小。</td></tr> <tr><td>minimumNumberOfCalls</td> <td>100</td> <td>断路器计算失败率或慢调用率之前所需的最小调用数（每个滑动窗口周期）。例如，如果minimumNumberOfCalls为10，则必须至少记录10个调用，然后才能计算失败率。如果只记录了9次调用，即使所有9次调用都失败，断路器也不会开启。</td></tr> <tr><td>waitDurationInOpenState</td> <td>60000 [ms]</td> <td>断路器从开启过渡到半开应等待的时间。</td></tr> <tr><td>automaticTransition FromOpenToHalfOpenEnabled</td> <td>false</td> <td>如果设置为true，则意味着断路器将自动从开启状态过渡到半开状态，并且不需要调用来触发转换。创建一个线程来监视断路器的所有实例，以便在WaitDurationInOpenstate之后将它们转换为半开状态。但是，如果设置为false，则只有在发出调用时才会转换到半开，即使在waitDurationInOpenState之后也是如此。这里的优点是没有线程监视所有断路器的状态。</td></tr> <tr><td>recordExceptions</td> <td>empty</td> <td>记录为失败并因此增加失败率的异常列表。 除非通过ignoreExceptions显式忽略，否则与列表中某个匹配或继承的异常都将被视为失败。 如果指定异常列表，则所有其他异常均视为成功，除非它们被ignoreExceptions显式忽略。</td></tr> <tr><td>ignoreExceptions</td> <td>empty</td> <td>被忽略且既不算失败也不算成功的异常列表。 任何与列表之一匹配或继承的异常都不会被视为失败或成功，即使异常是recordExceptions的一部分。</td></tr> <tr><td>recordException</td> <td>throwable -&gt; true· By default all exceptions are recored as failures.</td> <td>一个自定义断言，用于评估异常是否应记录为失败。 如果异常应计为失败，则断言必须返回true。如果出断言返回false，应算作成功，除非ignoreExceptions显式忽略异常。</td></tr> <tr><td>ignoreException</td> <td>throwable -&gt; false By default no exception is ignored.</td> <td>自定义断言来判断一个异常是否应该被忽略，如果应忽略异常，则谓词必须返回true。 如果异常应算作失败，则断言必须返回false。</td></tr></tbody></table> <p>  在订单项目中配置断路器，代码如下。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment">#失败请求百分比，超过这个比例，CircuitBreaker变为OPEN状态</span>
        <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#滑动窗口的大小，配置COUNT_BASED,表示10个请求，配置TIME_BASED表示10秒</span>
        <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment">#最小请求个数，只有在滑动窗口内，请求个数达到这个个数，才会触发CircuitBreader对于断路器的判断</span>
        <span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> TIME_BASED <span class="token comment">#滑动窗口的类型</span>
        <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#当CircuitBreaker处于HALF_OPEN状态的时候，允许通过的请求个数</span>
        <span class="token key atrule">automaticTransitionFromOpenToHalfOpenEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#设置true，表示自动从OPEN变成HALF_OPEN，即使没有请求过来</span>
        <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 2s <span class="token comment">#从OPEN到HALF_OPEN状态需要等待的时间</span>
        <span class="token key atrule">recordExceptions</span><span class="token punctuation">:</span> <span class="token comment">#异常名单</span>
          <span class="token punctuation">-</span> java.lang.Exception
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default <span class="token comment">#熔断器backendA，继承默认配置default</span>
      <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
        <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">slowCallDurationThreshold</span><span class="token punctuation">:</span> 2s <span class="token comment">#慢调用时间阈值，高于这个阈值的呼叫视为慢调用，并增加慢调用比例。</span>
        <span class="token key atrule">slowCallRateThreshold</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment">#慢调用百分比阈值，断路器把调用时间大于slowCallDurationThreshold，视为慢调用，当慢调用比例大于阈值，断路器打开，并进行服务降级</span>
        <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> TIME_BASED
        <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">2</span>
        <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">2</span>
        <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 2s <span class="token comment">#从OPEN到HALF_OPEN状态需要等待的时间</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>  上面配置了2个断路器&quot;backendA&quot;，和&quot;backendB&quot;，其中backendA断路器配置基于default配置，&quot;backendB&quot;断路器配置了慢调用比例熔断，&quot;backendA&quot;熔断器配置了异常比例熔断。</p> <h2 id="_2-4-ordercontroller"><a href="#_2-4-ordercontroller" class="header-anchor">#</a> 2.4 OrderController</h2> <p>  修改OrderController代码，以测试异常比例熔断和慢调用比例熔断效果，代码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@CircuitBreaker</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;backendD&quot;</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i enter the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//阻塞10秒，已测试慢调用比例熔断</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://cloud-payment-service/payment/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Payment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i exist the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payment<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        payment<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;fallback...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>payment<span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>  注意name=&quot;backendA&quot;和name=&quot;backendD&quot;效果相同，当找不到配置的backendD熔断器，使用默认熔断器配置，即为&quot;default&quot;。</p> <h2 id="_2-5-启动并测试"><a href="#_2-5-启动并测试" class="header-anchor">#</a> 2.5 启动并测试</h2> <p>  分别启动Eureka，支付服务，订单服务。</p> <p>  使用JMeter并发测试，创建线程组，如下图所示。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/301b461f58db4cb5866c21828e4629c0~tplv-k3u1fbpfcp-watermark.image?" alt="image.png">
  创建HTTP请求、查看结果数，HTTP请求配置。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bc2a3b7837840a7988a0b640b229540~tplv-k3u1fbpfcp-watermark.image?" alt="image.png">
  正常执行效果</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1000147a32e54d1c91154df591e23efa~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>  此时关闭支付微服务，这时订单服务无法调用，所有请求报错，这时第一次并发发送20次请求，触发异常比例熔断。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/340fcdaaf4dc42f08579e0b591684701~tplv-k3u1fbpfcp-watermark.image?" alt="image.png">
  断路器进入打开状态，2s后（waitDurationInOpenState: 2s），断路器自动进入半开状态（automaticTransitionFromOpenToHalfOpenEnabled: true），再次发送请求断路器处于半开状态，允许3次请求通过（permittedNumberOfCallsInHalfOpenState: 3），注意此时控制台打印3次日志信息，说明半开状态，进入了3次请求调用，接着断路器继续进入打开状态。如下图所示前3次请求通过。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d5721a03e4f4c1a83ebc7153192b2a8~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eec4d4e451fe49179e9fb8e911ec12c9~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5dadbf1c1da040138d11c788ec4d7422~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>以上是前三次时（<code>permittedNumberOfCallsInHalfOpenState</code>: 3）设置了处于HALF_OPEN状态时时允许通过3次的。</p></blockquote> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0bce9eef258a438b9a3d34bb9361a4b6~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>后续的都是说明<code>CircuitBreaker 'backendA'</code>处于半开状态不允许通过。</p></blockquote> <p>  下来测试慢比例调用熔断，修改OrderController代码，使用&quot;backendB&quot;熔断器，因为backendB熔断器，配置了慢比例调用熔断，然后启动Eureka，订单微服务和支付微服务。第一次发送并发发送了20个请求，触发了慢比例熔断。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2dedba9ece2142b3899ed88cd940d3c3~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>进入了10秒才开始退出。</p></blockquote> <p>  但是因为没有配置（automaticTransitionFromOpenToHalfOpenEnabled: true），无法自动从打开状态转为半开状态，需要浏览器中执行一次请求，这时，断路器才能从打开状态进入半开状态，接下来进入半开状态</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c13f9a71948146359c5ccb998a6981be~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>因此是进入了3次而不是两次，需要浏览器中执行一次请求，这时，断路器才能从打开状态进入半开状态。</p></blockquote> <p>  根据配置，允许2次请求在半开状态通过（permittedNumberOfCallsInHalfOpenState: 2），第二次调用效果如下图所示。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f611f37cbce04310bfc911d5247cd164~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <h1 id="_3-隔离-builkhead"><a href="#_3-隔离-builkhead" class="header-anchor">#</a> 3. 隔离(Builkhead)</h1> <p>  Resilience4j提供了两种隔离的实现方式，可以限制并发执行的数量。</p> <ul><li>SemaphoreBulkhead使用了信号量</li> <li>FixedThreadPoolBulkhead使用了有界队列和固定大小线程池</li></ul> <h2 id="_3-1-信号量隔离"><a href="#_3-1-信号量隔离" class="header-anchor">#</a> 3.1 信号量隔离</h2> <h3 id="_3-1-1-添加依赖"><a href="#_3-1-1-添加依赖" class="header-anchor">#</a> 3.1.1 添加依赖</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.resilience4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>resilience4j-bulkhead<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-1-2-信号量隔离"><a href="#_3-1-2-信号量隔离" class="header-anchor">#</a> 3.1.2 信号量隔离</h3> <p>  SemaphoreBulkhead使用了信号量，配置属性，如下表所示。</p> <table><thead><tr><th><strong>配置属性</strong></th> <th><strong>默认值</strong></th> <th><strong>描述</strong></th></tr></thead> <tbody><tr><td>maxConcurrentCalls</td> <td>25</td> <td>隔离允许线程并发执行的最大数量</td></tr> <tr><td>maxWaitDuration</td> <td>0</td> <td>当达到并发调用数量时，新的线程执行时将被阻塞，这个属性表示最长的等待时间。</td></tr></tbody></table> <p>  在订单工程application.yml配置如下。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">bulkhead</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConcurrentCalls</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 隔离允许并发线程执行的最大数量</span>
        <span class="token key atrule">maxWaitDuration</span><span class="token punctuation">:</span> 20ms <span class="token comment"># 当达到并发调用数量时，新的线程的阻塞时间</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default
      <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxWaitDuration</span><span class="token punctuation">:</span> 10ms
        <span class="token key atrule">maxConcurrentCalls</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>  修改OrderController代码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//    @CircuitBreaker(name = &quot;backendB&quot;, fallbackMethod = &quot;fallback&quot;)</span>
    <span class="token annotation punctuation">@Bulkhead</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Bulkhead<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">SEMAPHORE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;------enter the method--------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//阻塞10秒，已测试慢调用比例熔断</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://cloud-payment-service/payment/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Payment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;------exit the method----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>  执行并测试，可以看到因为并发线程数为5（maxConcurrentCalls: 5），只有5个线程进入执行，其他请求降直接降级。效果如下图所示。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eef3dd18ae664afbb22dc3c3fa30705d~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <h2 id="_3-2-线程池隔离"><a href="#_3-2-线程池隔离" class="header-anchor">#</a> 3.2 线程池隔离</h2> <p>FixedThreadPoolBulkhead配置如下，如下表所示。</p> <table><thead><tr><th><strong>配置名称</strong></th> <th><strong>默认值</strong></th> <th><strong>含义</strong></th></tr></thead> <tbody><tr><td>maxThreadPoolSize</td> <td>Runtime.getRuntime().availableProcessors()</td> <td>配置最大线程池大小</td></tr> <tr><td>coreThreadPoolSize</td> <td>Runtime.getRuntime().availableProcessors() - 1</td> <td>配置核心线程池大小</td></tr> <tr><td>queueCapacity</td> <td>100</td> <td>配置队列的容量</td></tr> <tr><td>keepAliveDuration</td> <td>20ms</td> <td>当线程数大于核心时，  这是多余空闲线程在终止前等待新任务的最长时间</td></tr></tbody></table> <p>  支付工程的application.yml，配置如下。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">thread-pool-bulkhead</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">4</span> <span class="token comment"># 最大线程池大小</span>
        <span class="token key atrule">coreThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 核心线程池大小</span>
        <span class="token key atrule">queueCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 队列容量</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default
      <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">coreThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">queueCapacity</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>  增加OrderService，注意，FixedThreadPoolBulkhead只对CompletableFuture方法有效，所以我们必创建返回CompletableFuture类型的方法。代码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bulkhead</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Bulkhead<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">THREADPOOL</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i enter the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i exist the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">&quot;线程池隔离回退。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>  修改OrderController代码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderService<span class="token punctuation">.</span><span class="token function">getPaymet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>  线程隔离配置如下图所示，4个请求进入线程执行（maxThreadPoolSize: 4 ），2个请求（queueCapacity: 2）进入有界队列等待，等待10秒后有线程执行结束，队列中的线程开始执行，如下图所示。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83efe20cf899458f975d0ccd135898f2~tplv-k3u1fbpfcp-watermark.image?" alt="image.png">
执行效果如下图所示</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c7d02f61a884219b8aef7657450b0f5~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69aa35e04bd545b9976c47abb3b05370~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>不难看出就是4个线程先执行后，退出了2个线程后，有界队列中的2个再进入。</p></blockquote> <h1 id="_4-限流-ratelimiter"><a href="#_4-限流-ratelimiter" class="header-anchor">#</a> 4. 限流(RateLimiter)</h1> <h2 id="_4-1-添加依赖"><a href="#_4-1-添加依赖" class="header-anchor">#</a> 4.1 添加依赖</h2> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.resilience4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>resilience4j-ratelimiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_4-2-配置文件"><a href="#_4-2-配置文件" class="header-anchor">#</a> 4.2 配置文件</h2> <p>  R4的限流模块RateLimter基于滑动窗口，和令牌桶限流算法，配置如下，如下表所示。</p> <table><thead><tr><th><strong>属性</strong></th> <th><strong>默认值</strong></th> <th><strong>描述</strong></th></tr></thead> <tbody><tr><td>timeoutDuration</td> <td>5秒</td> <td>线程等待权限的默认等待时间</td></tr> <tr><td>limitRefreshPeriod</td> <td>500纳秒</td> <td>限流器每隔limitRefreshPeriod刷新一次，将允许处理的最大请求数量重置为limitForPeriod。</td></tr> <tr><td>limitForPeriod</td> <td>50</td> <td>在一次刷新周期内，允许执行的最大请求数</td></tr></tbody></table> <p>  在订单工程的application.yml中配置如下。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">ratelimiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 线程等待权限的默认等待时间</span>
        <span class="token key atrule">limitRefreshPeriod</span><span class="token punctuation">:</span> 1s <span class="token comment"># 限流器每隔1s刷新一次，将允许处理的最大请求重置为2</span>
        <span class="token key atrule">limitForPeriod</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">#在一个刷新周期内，允许执行的最大请求数</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
      <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
        <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default
      <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
        <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">limitRefreshPeriod</span><span class="token punctuation">:</span> 1s
        <span class="token key atrule">limitForPeriod</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>  修改OrderController代码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RateLimiter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i enter the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//阻塞10秒，已测试慢调用比例熔断</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://cloud-payment-service/payment/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Payment</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;now i exist the method!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>  启动并测试，因为在一个刷新周期1s（limitRefreshPeriod: 1s）允许执行的最大请求数为2（limitForPeriod: 2），等待令牌时间5s（timeoutDuration: 5 ），限流逻辑如下图所示。并发发送20个请求后，只有2个请求拿到令牌执行，另外2个请求等5秒后拿到令牌，其他16个请求直接降级。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/921589f79217421da8c56baf148d0c86~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b5984703b3f4fa1be48e528b6ef7cc4~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/65863fe4fabf4e12bd77cd61c8852c31~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fd2fda9e20a41f2bbb5a93ae8b5b42f~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <blockquote><p>可以看到是先在1s刷新周期内先执行2个请求，等5s后拿到令牌再执行2个请求。</p></blockquote></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-1-微服务容错简介" class="sidebar-link reco-side-_1-1-微服务容错简介" data-v-b57cc07c>1.1 微服务容错简介</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-1-1-隔离" class="sidebar-link reco-side-_1-1-1-隔离" data-v-b57cc07c>1.1.1 隔离</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-1-2-熔断" class="sidebar-link reco-side-_1-1-2-熔断" data-v-b57cc07c>1.1.2 熔断</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-1-3-降级" class="sidebar-link reco-side-_1-1-3-降级" data-v-b57cc07c>1.1.3 降级</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-1-4-限流" class="sidebar-link reco-side-_1-1-4-限流" data-v-b57cc07c>1.1.4 限流</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-2-resilience4j简介" class="sidebar-link reco-side-_1-2-resilience4j简介" data-v-b57cc07c>1.2 Resilience4j简介</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-2-1-resilience4j简介" class="sidebar-link reco-side-_1-2-1-resilience4j简介" data-v-b57cc07c>1.2.1 Resilience4j简介</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_1-2-2-resilience4j和hystrix的异同" class="sidebar-link reco-side-_1-2-2-resilience4j和hystrix的异同" data-v-b57cc07c>1.2.2 Resilience4j和Hystrix的异同</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_2-1-circuitbreaker简介" class="sidebar-link reco-side-_2-1-circuitbreaker简介" data-v-b57cc07c>2.1 CircuitBreaker简介</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_2-2-添加依赖" class="sidebar-link reco-side-_2-2-添加依赖" data-v-b57cc07c>2.2 添加依赖</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_2-3-circuitbreaker配置" class="sidebar-link reco-side-_2-3-circuitbreaker配置" data-v-b57cc07c>2.3 CircuitBreaker配置</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_2-4-ordercontroller" class="sidebar-link reco-side-_2-4-ordercontroller" data-v-b57cc07c>2.4 OrderController</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_2-5-启动并测试" class="sidebar-link reco-side-_2-5-启动并测试" data-v-b57cc07c>2.5 启动并测试</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_3-1-信号量隔离" class="sidebar-link reco-side-_3-1-信号量隔离" data-v-b57cc07c>3.1 信号量隔离</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_3-1-1-添加依赖" class="sidebar-link reco-side-_3-1-1-添加依赖" data-v-b57cc07c>3.1.1 添加依赖</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_3-1-2-信号量隔离" class="sidebar-link reco-side-_3-1-2-信号量隔离" data-v-b57cc07c>3.1.2 信号量隔离</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_3-2-线程池隔离" class="sidebar-link reco-side-_3-2-线程池隔离" data-v-b57cc07c>3.2 线程池隔离</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_4-1-添加依赖" class="sidebar-link reco-side-_4-1-添加依赖" data-v-b57cc07c>4.1 添加依赖</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/SpringCloud/%E6%96%AD%E8%B7%AF%E5%99%A8(CircuitBreaker).html#_4-2-配置文件" class="sidebar-link reco-side-_4-2-配置文件" data-v-b57cc07c>4.2 配置文件</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.00ab6ad1.js" defer></script><script src="/assets/js/3.063946e3.js" defer></script><script src="/assets/js/1.f0dee50d.js" defer></script><script src="/assets/js/19.41d9e123.js" defer></script>
  </body>
</html>
