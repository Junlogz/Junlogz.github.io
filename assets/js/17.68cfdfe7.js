(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{421:function(a,t,s){"use strict";s.r(t);var n=s(2),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"_1-链路追踪简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-链路追踪简介"}},[a._v("#")]),a._v(" 1. 链路追踪简介")]),a._v(" "),t("h2",{attrs:{id:"_1-1-为什么需要链路追踪"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-为什么需要链路追踪"}},[a._v("#")]),a._v(" 1.1. 为什么需要链路追踪")]),a._v(" "),t("p",[a._v("  微服务架构是一个分布式架构，它按业务划分服务单元，一个分布式系统往往有很多个服务单元。由于服务单元数量众多，业务的复杂性，如果出现了错误和异常，很难去定位。主要体现在，一个请求可能需要调用很多个服务，而内部服务的调用复杂性，决定了问题难以定位。所以微服务架构中，必须实现分布式链路追踪，去跟进一个请求到底有哪些服务参与，参与的顺序又是怎样的，从而达到每个请求的步骤清晰可见，出了问题，很快定位。")]),a._v(" "),t("p",[a._v("  举个例子，在微服务系统中，一个来自用户的请求，请求先达到前端A（如前端界面），然后通过远程调用，到达系统的中间件B、C（如负载均衡、网关等），最后达到后端服务D、E，后端经过一系列的业务逻辑计算最后将数据返回给用户。对于这样一个请求，经历了这么多个服务，怎么样将它的请求过程的数据记录下来呢？这就需要用到服务链路追踪。")]),a._v(" "),t("p",[a._v("  Google开源的 Dapper链路追踪组件，并在2010年发表了论文《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》，这篇文章是业内实现链路追踪的标杆和理论基础，具有非常大的参考价值。目前，链路追踪组件有Google的Dapper，Twitter 的Zipkin，以及阿里的Eagleeye （鹰眼）等，它们都是非常优秀的链路追踪开源组件。")]),a._v(" "),t("h2",{attrs:{id:"_1-2-基本术语"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-基本术语"}},[a._v("#")]),a._v(" 1.2 基本术语")]),a._v(" "),t("p",[a._v("Spring Cloud Sleuth采用的是Google的开源项目Dapper的专业术语。如图7-1所示")]),a._v(" "),t("ul",[t("li",[a._v("Span：基本工作单元，发送一个远程调度任务 就会产生一个Span，Span有一个64位ID唯一标识的，Trace是用另一个64位ID唯一标识的，Span还有其他数据信息，比如摘要、时间戳事件、Span的ID、以及进度ID。")]),a._v(" "),t("li",[a._v("Trace：一系列Span组成的一个树状结构。请求一个微服务系统的API接口，这个API接口，需要调用多个微服务，调用每个微服务都会产生一个新的Span，所有由这个请求产生的Span组成了这个Trace。")]),a._v(" "),t("li",[a._v("Annotation：用来及时记录一个事件的，一些核心注解用来定义一个请求的开始和结束 。这些注解包括以下：\n"),t("ul",[t("li",[a._v("cs - Client Sent -客户端发送一个请求，这个注解描述了这个Span的开始")]),a._v(" "),t("li",[a._v("sr - Server Received -服务端获得请求并准备开始处理它，如果将其sr减去cs时间戳便可得到网络传输的时间。")]),a._v(" "),t("li",[a._v("ss - Server Sent （服务端发送响应）–该注解表明请求处理的完成(当请求返回客户端)，如果ss的时间戳减去sr时间戳，就可以得到服务器请求的时间。")]),a._v(" "),t("li",[a._v("cr - Client Received （客户端接收响应）-此时Span的结束，如果cr的时间戳减去cs时间戳便可以得到整个请求所消耗的时间。")])])])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7c8d30117cc42b2a4d5a2a07b70c065~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),a._v(" "),t("h1",{attrs:{id:"_2-案例实战"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-案例实战"}},[a._v("#")]),a._v(" 2. 案例实战")]),a._v(" "),t("h2",{attrs:{id:"_2-1-zipkin-server"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-zipkin-server"}},[a._v("#")]),a._v(" 2.1 Zipkin-Server")]),a._v(" "),t("h3",{attrs:{id:"_2-1-1-准备zipkin-server-步骤如下。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-准备zipkin-server-步骤如下。"}},[a._v("#")]),a._v(" 2.1.1 准备Zipkin-Server，步骤如下。")]),a._v(" "),t("ol",[t("li",[a._v("下载Zipkin-Server")]),a._v(" "),t("li",[a._v("启动Zipkin-Server")])]),a._v(" "),t("ul",[t("li",[a._v("java -jar zipkin-server-2.23.2-exec.jar")])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f1e55fd05b84a249c2424758db8a29a~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),a._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[a._v("访问9411")])]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/596fb086c6504371925d3b307471a44e~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),a._v(" "),t("h2",{attrs:{id:"_2-2-zipkin-client"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-zipkin-client"}},[a._v("#")]),a._v(" 2.2 ZipKin-Client")]),a._v(" "),t("p",[a._v("改造支付微服务项目，和订单微服务项目作为Zipkin客户端，需要将链路数据上传给Zipkin Server，具体步骤如下。")]),a._v(" "),t("h3",{attrs:{id:"_2-2-1-添加依赖"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-添加依赖"}},[a._v("#")]),a._v(" 2.2.1 添加依赖")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("        <dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("org.springframework.cloud</groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("spring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("cloud"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("sleuth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("zipkin</artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n        </dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n        <dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("org.springframework.cloud</groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("spring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("cloud"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("starter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("sleuth</artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n        </dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("h3",{attrs:{id:"_2-2-2-配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-配置文件"}},[a._v("#")]),a._v(" 2.2.2 配置文件")]),a._v(" "),t("p",[a._v("在支付和订单项目的配置文件application.yml配置Spring Cloud Sleuth链路追踪，代码如下")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("application")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" cloud"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("payment"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("service\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("zipkin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("base-url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9411")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sender")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" web\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sleuth")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sampler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("probability")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])]),t("ul",[t("li",[a._v("spring.zipkin.base-url：指定Zipkin的服务端，用于发送链路报告")]),a._v(" "),t("li",[a._v("spirng.zipkin.sender.type：web表示使用http发送数据")]),a._v(" "),t("li",[a._v("spring.sleuth.sampler.probability：采样率，值为[0,1]之间，这里表示100%采样报告")])]),a._v(" "),t("h3",{attrs:{id:"_2-2-3-启动并测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-启动并测试"}},[a._v("#")]),a._v(" 2.2.3 启动并测试")]),a._v(" "),t("p",[a._v("分别启动Zipkin-Server，Eureka，支付服务，订单服务，然后请求几次订单业务，这时链路报告会通过web方式发送给ZipkinServer，ZipkinServer收集的链路数据，如图所示。")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/010380d1bad94389b5f21815c5db598c~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),a._v(" "),t("h3",{attrs:{id:"_2-2-4-使用rabbitmq传输链路数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-4-使用rabbitmq传输链路数据"}},[a._v("#")]),a._v(" 2.2.4 使用RabbitMQ传输链路数据")]),a._v(" "),t("p",[a._v("在上述案例中最终收集的数据是通过HTTP上传给Zipkin-Server的，在Spring Cloud Sleuth中支持消息组件传输链路数据，本节使用RabbitMQ传输链路数据，步骤如下。")]),a._v(" "),t("p",[t("strong",[a._v("1. 安装RabbitMQ")])]),a._v(" "),t("p",[t("strong",[a._v("2. Zipkin-Server")])]),a._v(" "),t("p",[a._v("启动Zipkin-Server时，指定从RabbitMQ获得链路消息数据。命令如下。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token constant"}},[a._v("RABBIT_ADDRESSES")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("localhost java "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("jar zipkin"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("server"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2.23")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v(".2")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("exec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("jar \n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("启动如下图\n"),t("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d95fb6317c540ba9e6f65378590be5f~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}}),a._v(" "),t("strong",[a._v("3. Zipkin-Client")])]),a._v(" "),t("p",[a._v("在Zipkin-Client中添加依赖")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[a._v("        <dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("org.springframework.amqp</groupId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n            <artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("spring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("rabbit</artifactId"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n        </dependency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("在支付微服务，和订单微服务中修改配置，将链路数据发送给RabbitMQ。配置如下。")]),a._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("zipkin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("addresses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5672")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#    base-url: http://localhost:9411")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sender")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" rabbit\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sleuth")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sampler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("probability")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])]),t("p",[a._v("因为发送链路数据的方式type=rabbit，故此需要配置spring.zipkin.rabbitmq，同时base-url就不需要了。")]),a._v(" "),t("p",[t("strong",[a._v("4.启动并测试")])]),a._v(" "),t("p",[a._v("重启Zipkin-Server和Zipkin-Client，发现链路数据经由RabbitMQ发送给Zipkin-Server。")]),a._v(" "),t("p",[a._v("如下图所示")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db23e71c01ff41c3ac3d96d32653faf4~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),a._v(" "),t("p",[t("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fe5ace96a5d546348167f73dd75631c9~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})])])}),[],!1,null,null,null);t.default=e.exports}}]);